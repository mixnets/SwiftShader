From e2540106b756159d180677ac9f84da9af49dfd8a Mon Sep 17 00:00:00 2001
From: Nicolas Capens <capn@google.com>
Date: Wed, 5 Nov 2014 09:34:52 -0500
Subject: [PATCH 1/3] Load libraries from a list of possible names.

BUG=18208440

Change-Id: Ie57bf7c6fa40ec1f9d0c3780c360d281d84a8c56
---
 src/Common/SharedLibrary.hpp             | 45 ++++++++++++++++++++++++++++++++
 src/OpenGL/libEGL/libEGL.vcxproj         | 12 ++++++---
 src/OpenGL/libEGL/main.cpp               | 12 ++++-----
 src/OpenGL/libGLES_CM/libGLES_CM.vcxproj | 12 ++++++---
 src/OpenGL/libGLES_CM/main.cpp           |  4 +--
 src/OpenGL/libGLESv2/libGLESv2.vcxproj   | 12 ++++++---
 src/OpenGL/libGLESv2/main.cpp            | 10 +++----
 7 files changed, 85 insertions(+), 22 deletions(-)

diff --git a/src/Common/SharedLibrary.hpp b/src/Common/SharedLibrary.hpp
index 3f7836f..eadd35d 100644
--- a/src/Common/SharedLibrary.hpp
+++ b/src/Common/SharedLibrary.hpp
@@ -15,12 +15,45 @@
 	#include <dlfcn.h>
 #endif
 
+template<int n>
+void *loadLibrary(const char *(&names)[n])
+{
+	for(int i = 0; i < n; i++)
+	{
+		void *library = getLibraryHandle(names[i]);
+
+		if(library)
+		{
+			return library;
+		}
+	}
+
+	for(int i = 0; i < n; i++)
+	{
+		void *library = loadLibrary(names[i]);
+
+		if(library)
+		{
+			return library;
+		}
+	}
+
+	return 0;
+}
+
 #if defined(_WIN32)
 	inline void *loadLibrary(const char *path)
 	{
 		return (void*)LoadLibrary(path);
 	}
 
+	inline void *getLibraryHandle(const char *path)
+	{
+		HMODULE module = 0;
+		GetModuleHandleEx(0, path, &module);
+		return (void*)module;
+	}
+
 	inline void freeLibrary(void *library)
 	{
 		FreeLibrary((HMODULE)library);
@@ -36,6 +69,18 @@
 		return dlopen(path, RTLD_LAZY);
 	}
 
+	inline void *getLibraryHandle(const char *path)
+	{
+		bool resident = (dlopen(names[i], RTLD_NOLOAD) != 0);
+
+		if(resident)
+		{
+			return dlopen(path, RTLD_LAZY);   // Increment reference count
+		}
+
+		return 0;
+	}
+
 	inline void freeLibrary(void *library)
 	{
 		dlclose(library);
diff --git a/src/OpenGL/libEGL/libEGL.vcxproj b/src/OpenGL/libEGL/libEGL.vcxproj
index 51242f5..961dba8 100644
--- a/src/OpenGL/libEGL/libEGL.vcxproj
+++ b/src/OpenGL/libEGL/libEGL.vcxproj
@@ -89,7 +89,9 @@
     </Link>
     <PostBuildEvent>
       <Command>mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\"
-copy "$(OutDir)libEGL.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Command>
+copy "$(OutDir)libEGL.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"
+mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\"
+copy "$(OutDir)libEGL.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\libEGL_translator.dll"</Command>
     </PostBuildEvent>
   </ItemDefinitionGroup>
   <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
@@ -116,7 +118,9 @@ copy "$(OutDir)libEGL.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Comman
     </Link>
     <PostBuildEvent>
       <Command>mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\"
-copy "$(OutDir)libEGL.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Command>
+copy "$(OutDir)libEGL.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"
+mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\"
+copy "$(OutDir)libEGL.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\libEGL_translator.dll"</Command>
     </PostBuildEvent>
   </ItemDefinitionGroup>
   <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Profile|Win32'">
@@ -144,7 +148,9 @@ copy "$(OutDir)libEGL.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Comman
     </Link>
     <PostBuildEvent>
       <Command>mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\"
-copy "$(OutDir)libEGL.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Command>
+copy "$(OutDir)libEGL.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"
+mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\"
+copy "$(OutDir)libEGL.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\libEGL_translator.dll"</Command>
     </PostBuildEvent>
   </ItemDefinitionGroup>
   <ItemGroup>
diff --git a/src/OpenGL/libEGL/main.cpp b/src/OpenGL/libEGL/main.cpp
index aad1ab3..2243fd8 100644
--- a/src/OpenGL/libEGL/main.cpp
+++ b/src/OpenGL/libEGL/main.cpp
@@ -84,21 +84,21 @@ CONSTRUCTOR static bool eglAttachProcess()
 	eglAttachThread();
 
 	#if defined(_WIN32)
-	const char *libGLES_CM_lib = "libGLES_CM.dll";
+	const char *libGLES_CM_lib[] = {"libGLES_CM.dll", "libGLES_CM_translator.dll"};
 	#else
-	const char *libGLES_CM_lib = "libGLES_CM.so.1";
+	const char *libGLES_CM_lib[] = {"libGLES_CM.so.1", "libGLES_CM.so"};
 	#endif
-	
+
     libGLES_CM = loadLibrary(libGLES_CM_lib);
     es1::createContext = (egl::Context *(*)(const egl::Config*, const egl::Context*))getProcAddress(libGLES_CM, "glCreateContext");
     es1::getProcAddress = (__eglMustCastToProperFunctionPointerType (*)(const char*))getProcAddress(libGLES_CM, "glGetProcAddress");
 
 	#if defined(_WIN32)
-	const char *libGLESv2_lib = "libGLESv2.dll";
+	const char *libGLESv2_lib[] = {"libGLESv2.dll", "libGLES_V2_translator.dll"};
 	#else
-	const char *libGLESv2_lib = "libGLESv2.so.2";
+	const char *libGLESv2_lib[] = {"libGLESv2.so.2", "libGLESv2.so"};
 	#endif
-	
+
     libGLESv2 = loadLibrary(libGLESv2_lib);
     es2::createContext = (egl::Context *(*)(const egl::Config*, const egl::Context*))getProcAddress(libGLESv2, "glCreateContext");
     es2::getProcAddress = (__eglMustCastToProperFunctionPointerType (*)(const char*))getProcAddress(libGLESv2, "glGetProcAddress");
diff --git a/src/OpenGL/libGLES_CM/libGLES_CM.vcxproj b/src/OpenGL/libGLES_CM/libGLES_CM.vcxproj
index d10d323..47fbe7d 100644
--- a/src/OpenGL/libGLES_CM/libGLES_CM.vcxproj
+++ b/src/OpenGL/libGLES_CM/libGLES_CM.vcxproj
@@ -91,7 +91,9 @@
     </Link>
     <PostBuildEvent>
       <Command>mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\"
-copy "$(OutDir)libGLES_CM.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Command>
+copy "$(OutDir)libGLES_CM.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"
+mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\"
+copy "$(OutDir)libGLES_CM.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\libGLES_CM_translator.dll"</Command>
     </PostBuildEvent>
   </ItemDefinitionGroup>
   <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
@@ -124,7 +126,9 @@ copy "$(OutDir)libGLES_CM.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Co
     </Link>
     <PostBuildEvent>
       <Command>mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\"
-copy "$(OutDir)libGLES_CM.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Command>
+copy "$(OutDir)libGLES_CM.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"
+mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\"
+copy "$(OutDir)libGLES_CM.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\libGLES_CM_translator.dll"</Command>
     </PostBuildEvent>
   </ItemDefinitionGroup>
   <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Profile|Win32'">
@@ -156,7 +160,9 @@ copy "$(OutDir)libGLES_CM.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Co
     </Link>
     <PostBuildEvent>
       <Command>mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\"
-copy "$(OutDir)libGLES_CM.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Command>
+copy "$(OutDir)libGLES_CM.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"
+mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\"
+copy "$(OutDir)libGLES_CM.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\libGLES_CM_translator.dll"</Command>
     </PostBuildEvent>
   </ItemDefinitionGroup>
   <ItemGroup>
diff --git a/src/OpenGL/libGLES_CM/main.cpp b/src/OpenGL/libGLES_CM/main.cpp
index 8de1b70..dd18858 100644
--- a/src/OpenGL/libGLES_CM/main.cpp
+++ b/src/OpenGL/libGLES_CM/main.cpp
@@ -44,9 +44,9 @@ CONSTRUCTOR static bool glAttachProcess()
     glAttachThread();
 
 	#if defined(_WIN32)
-	const char *libEGL_lib = "libEGL.dll";
+	const char *libEGL_lib[] = {"libEGL.dll", "libEGL_translator.dll"};
 	#else
-	const char *libEGL_lib = "libEGL.so.1";
+	const char *libEGL_lib[] = {"libEGL.so.1", "libEGL.so"};
 	#endif
 
 	libEGL = loadLibrary(libEGL_lib);
diff --git a/src/OpenGL/libGLESv2/libGLESv2.vcxproj b/src/OpenGL/libGLESv2/libGLESv2.vcxproj
index c833496..d7cd0bd 100644
--- a/src/OpenGL/libGLESv2/libGLESv2.vcxproj
+++ b/src/OpenGL/libGLESv2/libGLESv2.vcxproj
@@ -91,7 +91,9 @@
     </Link>
     <PostBuildEvent>
       <Command>mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\"
-copy "$(OutDir)libGLESv2.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Command>
+copy "$(OutDir)libGLESv2.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"
+mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\translator"
+copy "$(OutDir)libGLESv2.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\libGLES_V2_translator.dll"</Command>
     </PostBuildEvent>
   </ItemDefinitionGroup>
   <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
@@ -124,7 +126,9 @@ copy "$(OutDir)libGLESv2.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Com
     </Link>
     <PostBuildEvent>
       <Command>mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\"
-copy "$(OutDir)libGLESv2.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Command>
+copy "$(OutDir)libGLESv2.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"
+mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\translator"
+copy "$(OutDir)libGLESv2.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\libGLES_V2_translator.dll"</Command>
     </PostBuildEvent>
   </ItemDefinitionGroup>
   <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Profile|Win32'">
@@ -156,7 +160,9 @@ copy "$(OutDir)libGLESv2.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Com
     </Link>
     <PostBuildEvent>
       <Command>mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\"
-copy "$(OutDir)libGLESv2.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"</Command>
+copy "$(OutDir)libGLESv2.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\"
+mkdir "$(ProjectDir)..\..\..\lib\$(Configuration)\translator"
+copy "$(OutDir)libGLESv2.dll" "$(ProjectDir)..\..\..\lib\$(Configuration)\translator\libGLES_V2_translator.dll"</Command>
     </PostBuildEvent>
   </ItemDefinitionGroup>
   <ItemGroup>
diff --git a/src/OpenGL/libGLESv2/main.cpp b/src/OpenGL/libGLESv2/main.cpp
index 14e4053..6252cf8 100644
--- a/src/OpenGL/libGLESv2/main.cpp
+++ b/src/OpenGL/libGLESv2/main.cpp
@@ -43,10 +43,10 @@ CONSTRUCTOR static bool glAttachProcess()
 
     glAttachThread();
 
-    #if defined(_WIN32)
-	const char *libEGL_lib = "libEGL.dll";
+	#if defined(_WIN32)
+	const char *libEGL_lib[] = {"libEGL.dll", "libEGL_translator.dll"};
 	#else
-	const char *libEGL_lib = "libEGL.so.1";
+	const char *libEGL_lib[] = {"libEGL.so.1", "libEGL.so"};
 	#endif
 
 	libEGL = loadLibrary(libEGL_lib);
@@ -54,9 +54,9 @@ CONSTRUCTOR static bool glAttachProcess()
 	egl::getCurrentDisplay = (egl::Display *(*)())getProcAddress(libEGL, "eglGetCurrentDisplay");
 
 	#if defined(_WIN32)
-	const char *libGLES_CM_lib = "libGLES_CM.dll";
+	const char *libGLES_CM_lib[] = {"libGLES_CM.dll", "libGLES_CM_translator.dll"};
 	#else
-	const char *libGLES_CM_lib = "libGLES_CM.so.1";
+	const char *libGLES_CM_lib[] = {"libGLES_CM.so.1", "libGLES_CM.so"};
 	#endif
 
 	libGLES_CM = loadLibrary(libGLES_CM_lib);
-- 
1.8.5.2.msysgit.0

